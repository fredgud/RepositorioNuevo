<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Regresi√≥n Log√≠stica - Detecci√≥n de Fraude</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: linear-gradient(120deg, #f3e5f5, #e8f5e9);
      text-align: center;
      padding: 20px;
      color: #333;
    }
    h1 { color: #2c3e50; margin-bottom: 10px; }
    #status { font-weight: bold; margin: 10px 0; color: #00695c; }
    button { padding: 12px 24px; margin: 10px; border: none; background: #4CAF50; color: white; font-size: 16px; border-radius: 8px; cursor: pointer; transition: 0.3s; }
    button:hover:not(:disabled) { background: #388E3C; transform: scale(1.05); }
    button:disabled { background: #999; cursor: not-allowed; }
    .card { margin: 20px auto; max-width: 500px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); text-align: left; }
    .card h3 { margin-top: 0; color: #2c3e50; }
    .input-box { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
    .input-box input { padding: 8px; border: 1px solid #ccc; border-radius: 6px; }
    #predictionBox { margin-top: 15px; font-size: 18px; font-weight: bold; }
    .positivo { color: red; }
    .negativo { color: green; }
    .infografia { margin: 30px auto; max-width: 600px; background: #fff3e0; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-align: left; line-height: 1.6; }
    .infografia h2 { color: #e65100; margin-top: 0; }
    #metrics { margin-top: 15px; font-size: 16px; background: #e3f2fd; padding: 12px; border-radius: 10px; }
  </style>
</head>
<body>
  <h1>üí≥ Regresi√≥n Log√≠stica - Detecci√≥n de Fraude</h1>

  <input type="file" id="fileInput" accept=".csv">
  <p id="status">Estado: esperando archivo‚Ä¶</p>

  <button id="trainBtn" disabled>‚öôÔ∏è Entrenar Modelo</button>

  <div class="card">
    <h3>üîÆ Predicci√≥n</h3>
    <div class="input-box">
      <input type="number" id="amountInput" placeholder="Monto de transacci√≥n">
      <input type="number" id="balanceInput" placeholder="Saldo de cuenta">
      <input type="number" id="dailyCountInput" placeholder="Transacciones diarias">
      <input type="number" id="avgAmount7dInput" placeholder="Promedio √∫ltimos 7 d√≠as">
      <button id="predictBtn" disabled>Predecir</button>
    </div>
    <div id="predictionBox">Resultado: ‚Äî</div>
  </div>

  <div class="infografia" id="infografia" style="display:none;">
    <h2>üìù Infograf√≠a del Modelo</h2>
    <p><b>Variables independientes:</b> Monto, Saldo, Transacciones diarias, Promedio 7 d√≠as</p>
    <p><b>Variable dependiente:</b> Fraude (0 = normal, 1 = fraude)</p>
    <p><b>M√©todo aplicado:</b> Regresi√≥n Log√≠stica M√∫ltiple con Gradiente Descendente.</p>
    <p style="text-align:center; font-weight:bold;" id="equation"></p>
    <div id="metrics"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script>
    let dataX1=[], dataX2=[], dataX3=[], dataX4=[], dataY=[];
    let w1=0, w2=0, w3=0, w4=0, bias=0;

    const fileInput = document.getElementById("fileInput");
    const trainBtn = document.getElementById("trainBtn");
    const predictBtn = document.getElementById("predictBtn");
    const amountInput = document.getElementById("amountInput");
    const balanceInput = document.getElementById("balanceInput");
    const dailyCountInput = document.getElementById("dailyCountInput");
    const avgAmount7dInput = document.getElementById("avgAmount7dInput");
    const predictionBox = document.getElementById("predictionBox");
    const equationBox = document.getElementById("equation");
    const infografia = document.getElementById("infografia");
    const metricsBox = document.getElementById("metrics");
    const status = document.getElementById("status");

    function sigmoid(z){ return 1/(1+Math.exp(-z)); }

    fileInput.addEventListener("change", function(e){
      const file = e.target.files[0];
      Papa.parse(file, {
        header:true,
        dynamicTyping:true,
        complete: function(results){
          dataX1 = results.data.map(r=>r.Transaction_Amount).filter(v=>!isNaN(v));
          dataX2 = results.data.map(r=>r.Account_Balance).filter(v=>!isNaN(v));
          dataX3 = results.data.map(r=>r.Daily_Transaction_Count).filter(v=>!isNaN(v));
          dataX4 = results.data.map(r=>r.Avg_Transaction_Amount_7d).filter(v=>!isNaN(v));
          dataY = results.data.map(r=>r.Fraud_Label).filter(v=>v===0||v===1);

          if(dataX1.length>0 && dataX2.length>0 && dataX3.length>0 && dataX4.length>0 && dataY.length>0){
            status.textContent="‚úÖ Archivo cargado correctamente";
            trainBtn.disabled=false;
          }else{
            status.textContent="‚ö†Ô∏è No se encontraron las columnas necesarias";
          }
        }
      });
    });

    trainBtn.addEventListener("click",()=>{
      let lr=0.000001, epochs=5000;
      w1=w2=w3=w4=bias=0;
      for(let i=0;i<epochs;i++){
        let dw1=0,dw2=0,dw3=0,dw4=0,db=0;
        for(let j=0;j<dataY.length;j++){
          let x1=dataX1[j], x2=dataX2[j], x3=dataX3[j], x4=dataX4[j], y=dataY[j];
          let z = w1*x1 + w2*x2 + w3*x3 + w4*x4 + bias;
          let y_pred = sigmoid(z);
          dw1 += (y_pred-y)*x1; dw2 += (y_pred-y)*x2; dw3 += (y_pred-y)*x3; dw4 += (y_pred-y)*x4;
          db += (y_pred-y);
        }
        w1 -= lr*dw1/dataY.length; w2 -= lr*dw2/dataY.length; w3 -= lr*dw3/dataY.length; w4 -= lr*dw4/dataY.length; bias -= lr*db/dataY.length;
      }

      // M√©tricas
      let tp=0, tn=0, fp=0, fn=0;
      for(let i=0;i<dataY.length;i++){
        let prob = sigmoid(w1*dataX1[i]+w2*dataX2[i]+w3*dataX3[i]+w4*dataX4[i]+bias);
        let pred = prob>=0.5?1:0;
        if(pred===1 && dataY[i]===1) tp++;
        else if(pred===0 && dataY[i]===0) tn++;
        else if(pred===1 && dataY[i]===0) fp++;
        else if(pred===0 && dataY[i]===1) fn++;
      }
      let accuracy=(tp+tn)/(tp+tn+fp+fn);
      let precision=tp/(tp+fp||1);
      let recall=tp/(tp+fn||1);
      let f1=2*precision*recall/(precision+recall||1);

      status.textContent=`üìê Modelo entrenado con ${epochs} iteraciones`;
      equationBox.textContent=`P(y=1|X) = sigmoid(${w1.toFixed(4)}¬∑amt + ${w2.toFixed(4)}¬∑balance + ${w3.toFixed(4)}¬∑dailyCount + ${w4.toFixed(4)}¬∑avg7d + ${bias.toFixed(4)})`;
      metricsBox.innerHTML=`
        <h3>üìä M√©tricas del Modelo</h3>
        <p><b>Accuracy:</b> ${(accuracy*100).toFixed(2)}%</p>
        <p><b>Precision:</b> ${(precision*100).toFixed(2)}%</p>
        <p><b>Recall:</b> ${(recall*100).toFixed(2)}%</p>
        <p><b>F1-score:</b> ${(f1*100).toFixed(2)}%</p>
      `;
      predictBtn.disabled=false;
      infografia.style.display="block";
    });

    predictBtn.addEventListener("click",()=>{
      const x1=parseFloat(amountInput.value);
      const x2=parseFloat(balanceInput.value);
      const x3=parseFloat(dailyCountInput.value);
      const x4=parseFloat(avgAmount7dInput.value);
      if(!isNaN(x1)&&!isNaN(x2)&&!isNaN(x3)&&!isNaN(x4)){
        const prob = sigmoid(w1*x1 + w2*x2 + w3*x3 + w4*x4 + bias);
        const pred = prob>=0.5? `<span class="positivo">‚ö†Ô∏è Positivo (Fraude)</span>` : `<span class="negativo">‚úÖ Negativo (Normal)</span>`;
        predictionBox.innerHTML=`Probabilidad: ${(prob*100).toFixed(2)}% ‚Üí ${pred}`;
      }else{
        predictionBox.textContent="‚ö†Ô∏è Ingrese valores v√°lidos";
      }
    });
  </script>
</body>
</html>
